var backInterval;var oldUrl;var loadPayment=false;var promocodeSectionExpanded=false;let processingPromoCode=false;var isDDFormExpanded=false;$(window).resize(function(){adjustDDIframeHeight(isDDFormExpanded)});
$(document).ready(function(){oldUrl=window.location.href.split("?")[0];moment.now=()=>currentDate.split("T")[0];let todayDate=moment().format("DD/MM/YYYY");if(paymentFail){eraseCookie("paymentFail");$("#errorMessage").text(paymentFailMessage);$("#errorModalOpener").click()}validate();$("#promocodeBtn").on("click",function(){if(isPromoCodeValid)removePromocodeBtnHandler();else promocodeBtnHandler()});$("#payment-proceed, #payment-proceed-annual").on("click",function(){if((businessFlow=="IDOL"||businessFlow==
"MSM"||businessFlow=="QUOTEZONE"||businessFlow=="GOCO")&&isExistAnyPriceTooHighPets())$("#costHighModal").modal("show");else proceedPaymentBtnHandler()});$("#agreeTermsBusiness, input[name\x3dcoverlevel]").change(function(){if($("#standardCover").is(":checked")){$("#wording-for-monthly").show();$("#directDebitPayMethod").show()}else{$("#wording-for-monthly").hide();if(directDebitAnnualPaymentEnabled)$("#directDebitPayMethod").show();else $("#directDebitPayMethod").hide()}showPaymentMethodSection();
showHideTermsAgreementSection();validate()});$("input[name\x3dpayMethod]").change(function(e){payMethodChangeHandler();validatePaymentMethodSection();validate();initializePaymentDayDropDown($("#creditDebit").is(":checked")?"CARD":"DIRECT_DEBIT")});$(".back-btn").on("click",function(e){goBack({quoteReference,personReference,propertyReference},{})});$("#promocodeInput").on("keyup",function(e){var promoCode=$(this).val();if(promoCode.search(/\s/g)!=-1)$(this).val(promoCode.replace(/\s/g,""));else{displayPromoError(false,
"");if(!isValidPromoCode(promoCode)){displayPromoError(true,"Invalid input.");$("#promocodeBtn").attr("disabled",true)}else{displayPromoError(false,"");$("#promocodeBtn").attr("disabled",false);if(e.keyCode===13&&!processingPromoCode){$("#promocodeBtn").trigger("click");processingPromoCode=true}}if(promoCode.length==0)$("#promocodeBtn").attr("disabled",true)}});setPromoCodeDetails();$("#gotPromocodeBtn").on("click",function(){if($("#promocodeInput").val()=="")$("#promocodeBtn").attr("disabled",true);
promocodeSectionHandler()});$("input[name\x3dfirstPaymentDate]").on("click",function(){firstPaymentDateSelectPostProcess();initializePaymentDayDropDown($("#creditDebit").is(":checked")?"CARD":"DIRECT_DEBIT")});$("#payment-date").on("change",function(){validatePaymentMethodSection()});showPaymentMethodSection();showHideTermsAgreementSection();if($("#standardCover").is(":checked"))$("#wording-for-monthly").show();else $("#wording-for-monthly").hide();window.addEventListener("message",(event)=>{isDDFormExpanded=
event.data=="expand";adjustDDIframeHeight(isDDFormExpanded)},false);if($("#agreeTermsBusiness").is(":checked"))$("#paymentMethodSection").show()});
function makePaymentPageInputsReadOnly(){$("input[name\x3dpayMethod]").each(function(){$(this).bind("click",function(){return false})});$("input[name\x3dcoverlevel]").each(function(){$(this).bind("click",function(){return false})});$("input[name\x3dfirstPaymentDate]").each(function(){$(this).unbind("click");$(this).bind("click",function(){return false})});$("#agreeTermsBusiness").bind("click",function(){return false});$("#payment-date").prop("disabled",true);$("#payment-proceed").prop("disabled",
true);$("#payment-proceed-annual").prop("disabled",true);$("#gotPromocodeBtn").prop("disabled",true);$("#promocodeBtn").prop("disabled",true)}
function firstPaymentDateSelectPreProcess(){let today=moment().format("DD/MM/YYYY");$("#payment-date-today").val(today);selectedDate=policyStartDate;if(moment(today,"DD/MM/YYYY").isSame(moment(policyStartDate,"DD/MM/YYYY")))$("#payment-date-today").prop("checked",true);else $("#payment-date-other").prop("checked",true);$("#payment-date-other-label").text(moment(policyStartDate,"DD/MM/YYYY").format("DD MMMM YYYY"));$("#first-payment-date-str").text(moment(selectedDate,"DD/MM/YYYY").format("DD MMMM YYYY"))}
function validatePaymentMethodSection(){let firstPaymentDate=$("input[name\x3dfirstPaymentDate]:checked").val();let paymentDate=$("#payment-date").val();let cardType=$("input[name\x3dpayMethod]:checked").val();let today=moment().format("DD/MM/YYYY");let valid=(cardType=="1"||cardType=="2")&&moment(firstPaymentDate,"DD/MM/YYYY").isValid()&&!moment(firstPaymentDate,"DD/MM/YYYY").isBefore(moment(today,"DD/MM/YYYY"))&&paymentDate>0&&paymentDate<32;$("#payment-proceed").prop("disabled",!valid);return valid}
function firstPaymentDateSelectPostProcess(){if($("#payment-date-other").is(":checked")){selectedDate=policyStartDate;$("#payment-date-other-label").text(moment(selectedDate,"DD/MM/YYYY").format("DD MMMM YYYY"))}else if($("#payment-date-today").is(":checked"))selectedDate=moment().format("DD/MM/YYYY");$("#first-payment-date-str").text(moment(selectedDate,"DD/MM/YYYY").format("DD MMMM YYYY"));validatePaymentMethodSection()}
function promocodeSectionHandler(){if(promocodeSectionExpanded){$("#addPromocodeSection").hide(100);$("#gotPromocodeBtn \x3e\x3e i").addClass("fa-plus");$("#gotPromocodeBtn \x3e\x3e i").removeClass("fa-minus");promocodeSectionExpanded=false}else{$("#addPromocodeSection").show(100);$("#gotPromocodeBtn \x3e\x3e i").removeClass("fa-plus");$("#gotPromocodeBtn \x3e\x3e i").addClass("fa-minus");promocodeSectionExpanded=true}}
function showHideTermsAgreementSection(){if($("input[name\x3dcoverlevel]").is(":checked"))$("#termsAgreementSection").show();else $("#termsAgreementSection").hide()}
function showPaymentMethodSection(){$("input[name\x3dpayMethod]").each(function(){$(this).prop("checked",false)});if($("#standardCover").is(":checked")){$("input[name\x3dfirstPaymentDate]").each(function(){$(this).prop("checked",false)});$("button[name\x3dpayment-proceed-annually]").hide();payMethodChangeHandler();firstPaymentDateSelectPreProcess()}else if($("#plusCover").is(":checked")){$("#first-payment-date-selection-section").hide();$("#payment-day-selection-section").hide();$("button[name\x3dpayment-proceed-annually]").prop("disabled",
true);$("button[name\x3dpayment-proceed-annually]").show()}else{$("#paymentMethodSection").prop("disabled",true);$("#paymentMethodSection").hide()}validatePaymentMethodSection()}
function payMethodChangeHandler(){if(($("#creditDebit").is(":checked")||$("#directDebit").is(":checked"))&&$("#standardCover").is(":checked")){if($("#creditDebit").is(":checked")){initializePaymentDayDropDown("CARD");$("#first-payment-date-selection-section .credit-debit-label").show();$("#payment-day-selection-section .credit-debit-label").show();$("#first-payment-date-selection-section .direct-debit-label").hide();$("#payment-day-selection-section .direct-debit-label").hide()}else{initializePaymentDayDropDown("DIRECT_DEBIT");
$("#first-payment-date-selection-section .direct-debit-label").show();$("#payment-day-selection-section .direct-debit-label").show();$("#first-payment-date-selection-section .credit-debit-label").hide();$("#payment-day-selection-section .credit-debit-label").hide()}$("#payment-day-selection-section").show();let todayDate=moment().format("DD/MM/YYYY");if(policyStartDate!=todayDate)$("#first-payment-date-selection-section").show()}else{$("#payment-day-selection-section").hide();$("#first-payment-date-selection-section").hide()}}
function initializePaymentDayDropDown(cardType){if(!$("#plusCover").is(":checked")){$("#payment-date").empty();$("#payment-proceed").prop("disabled",true);const select=document.querySelector("#payment-date");let selectedFirstPaymentDate;if($("#payment-date-today").is(":checked"))selectedFirstPaymentDate="TODAY";else if($("#payment-date-other").is(":checked"))selectedFirstPaymentDate="POLICY_START_DATE";let regularPaymentDayList=regularPaymentDays[cardType][selectedFirstPaymentDate].dates;select.options.add(new Option("Date",
""));for(const regularPaymentDayListElement of regularPaymentDayList){let i=regularPaymentDayListElement.day;let val=i.toString();let option=new Option(val,val);option.id="payment-day-option_"+i;select.options.add(option);$("#payment-day-option_"+i).attr("disabled",!regularPaymentDayListElement.enable)}$("#payment-date option:first-child").attr("hidden",true);$("#payment-date option:first-child").attr("selected",true);$("#payment-date option:first-child").attr("disabled",true)}}
function validate(){if(!($("#agreeTermsBusiness").is(":checked")&&($("#standardCover").is(":checked")||$("#plusCover").is(":checked")))){$("#payment-proceed").prop("disabled",true);$("#paymentMethodSection").addClass("disabled");$("#paymentMethodSection").hide()}else{if($("#paymentMethodSection").hasClass("disabled")){$("#paymentMethodSection").removeClass("disabled");$("#paymentMethodSection").show()}if($("#plusCover").is(":checked")&&$("#agreeTermsBusiness").is(":checked")&&($("input[name\x3dpayMethod]:checked").val()==
1||$("input[name\x3dpayMethod]:checked").val()==2))$("button[name\x3dpayment-proceed-annually]").prop("disabled",false)}}
function proceedPaymentBtnHandler(){gtmSubmit();$("#loaderModalLoader").click();let paymentType=$("#standardCover").is(":checked")?"MONTHLY":$("#plusCover").is(":checked")?"FULL":null;let isOptOutAutoRenewal="N";let confirm="Y";let cardType=$("input[name\x3dpayMethod]:checked").val();let firstPaymentDate=$("#standardCover").is(":checked")?selectedDate:"";let regularPaymentDay=$("#standardCover").is(":checked")?$("#payment-date").val():"";$.ajax({type:"POST",timeout:5E4,data:{action:"agreement-confirm",
quoteReference,personReference,isOptOutAutoRenewal,paymentType,confirm,partName,cardType,firstPaymentDate,regularPaymentDay},success:function(response){response=JSON.parse(response);if(response.success){mainTreeVersion++;$("#paymentIFrameContainer").show();let wording=paymentIframeWordingList["payment-iframe-wording-default"];if(cardType=="1"){let selectedPaymentDate=$("#payment-date").val();let today=moment().format("DD/MM/YYYY");if(moment(today,"DD/MM/YYYY").isSame(moment(selectedDate,"DD/MM/YYYY"))){wording=
paymentIframeWordingList["payment-iframe-wording-today-start"];wording=wording.replace("@selectedPaymentDate@",selectedPaymentDate)}else{wording=paymentIframeWordingList["payment-iframe-wording-future-start"];wording=wording.replace("@monthlyCostStr@",monthlyCostStr);wording=wording.replace("@selectedDate@",moment(selectedDate,"DD/MM/YYYY").format("DD MMMM YYYY"));wording=wording.replace("@selectedPaymentDate@",selectedPaymentDate)}}else if(cardType=="2")wording="";$("#paymentIFrameContainer").first().append("\x3cdiv\x3e"+
wording+'\x3ciframe frameborder\x3d"0" style\x3d"overflow:hidden;height:100vh;width:100%" width\x3d"100%" id\x3d"paymentFrame" src\x3d"'+response.paymentUrl+'"\x3e\x3c/iframe\x3e\x3c/div\x3e');adjustDDIframeHeight(false);if(window.history&&history.pushState){let refreshUrl=window.location.href.indexOf("?b\x3d1")>-1?window.location.href:window.location.href+"?b\x3d1";history.pushState(null,null,refreshUrl)}makePaymentPageInputsReadOnly();scrollToPaymentIFrame();backInterval=setInterval(function(){if(oldUrl==
window.location.href){$("#loaderModalLoader").click();clearInterval(backInterval);window.location.reload()}},500);setIncrementalInterval(function(){if(!loadPayment)$("#paymentFrame").attr("src",response.paymentUrl)},4E3,2E3);$("#paymentFrame").on("load",function(evt){if(!loadPayment){$("#loaderModalLoader").click();loadPayment=true}if($("#paymentFrame").contents().length>0&&$("#paymentFrame").contents().get(0).location.href.indexOf(baseURL)>-1){$("#loaderModalLoader").click();let isDirectDebit=$("input[name\x3dpayMethod]:checked").val()==
"2";const gatewayReference=$("#paymentFrame").contents().get(0).location.href.split(isDirectDebit?"directDebitGatewayReference\x3d":"gatewayReference\x3d")[1];if(gatewayReference.indexOf("requestBack\x3dBack")>-1)goNext({quoteReference,personReference,messageCode:"2648",paymentFail:"Y"},{paymentFail:true});else{const action="payment-complete";mainTreeVersion++;$.ajax({type:"POST",data:{quoteReference,personReference,gatewayReference,action,partName,isDirectDebit},timeout:5E4,success:function(response){response=
JSON.parse(response);if(response.success){let orderSubtotal=immediateMonthlyPayment;if(paymentType=="FULL")orderSubtotal=annualCosts.total.total;var _response={"purchasedQuote":response.purchasedQuote,"purchasedPolicy":response.purchasedPolicy,"newCost":response.newCost,"monthlyCosts":monthlyCosts,"annualCosts":annualCosts,"purchasedQuote":response.purchasedQuote,"payMethod":$("input[name\x3dpayMethod]:checked").val(),"customerDetails":customer,"order_subtotal":orderSubtotal};_response.purchasedQuote.properties=
[];goNext({quoteReference,personReference,response:JSON.stringify(_response)},{paymentSuccess:true})}else goNext({quoteReference,personReference,messageCode:response.messageCode,paymentFail:"Y"},{paymentFail:true})},error:function(){goNext({quoteReference,personReference,messageCode:response.messageCode,paymentFail:"Y"},{paymentFail:true})}})}}})}else{$("#loaderModal").modal("hide");$("#errorMessage").text(response.message);$("#errorModalOpener").click()}},error:function(response){let responseText=
JSON.parse(response.responseText);$("#loaderModal").modal("hide");$("#errorMessage").text(responseText.message.replace("\x3cbr\x3e\x3cbr\x3e"," "));$("#errorModalOpener").click()}})}
function removePromocodeBtnHandler(){displayPromoLoading(true);$("#promocodeBtn").prop("disabled",true);$.ajax({type:"POST",data:{action:"remove-promo-code",quoteReference,personReference,promocode:"",partName},timeout:5E4,success:function(res){mainTreeVersion++;gtmVoucherAction("remove voucher","");processingPromoCode=false;let response=JSON.parse(res);$("#promocodeBtn").prop("disabled",false);displayPromoLoading(false);$("#promocodeInput").val("");$("#promocodeBtn").prop("disabled",true);if(response.success){$("#promocodeInput").prop("readonly",
false);$("#promocodeBtn").text("Add");isPromoCodeValid=false;$("#promocodeDiv").show();$("#promocodeMsgDiv").hide()}},error:function(res){$("#promocodeBtn").prop("disabled",false);processingPromoCode=false;let response=JSON.parse(res.responseText);displayPromoLoading(false);$("#promocodeDiv").hide();$("#promocodeMsgDiv").show();displayPromoError(true,response.promo_content)}})}
function promocodeBtnHandler(e){gtmSubmit();$("#promocodeBtn").attr("disabled",true);let promocode=$("#promocodeInput").val();displayPromoLoading(true);if(isValidPromoCode(promocode)&&promocode)$.ajax({type:"POST",data:{action:"add-promo-code",quoteReference,personReference,promocode:promocode,partName},timeout:5E4,success:function(response){response=JSON.parse(response);mainTreeVersion++;if(response.success){gtmVoucherAction("add voucher",promocode);displayPromoLoading(false);$("#promocodeMsgDiv").show();
$("#promocodeMsgContent").html(response.promo_content);isPromoCodeValid=true;promoCodeSaved=promocode;displayPromoError(false,"");$("#promocodeBtn").attr("disabled",false);$("#promocodeBtn").text("Remove");$("#promocodeInput").prop("readonly",true)}else{$("#promocodeBtn").attr("disabled",false);$("#promocodeDiv").show();isPromoCodeValid=false;displayPromoLoading(false);displayPromoError(true,response.promo_content)}},error:function(response){response=JSON.parse(response.responseText);$("#promocodeBtn").attr("disabled",
false);displayPromoLoading(false);displayPromoError(true,response.promo_content?response.promo_content:response)}});else displayPromoError(true,"Invalid input.")}function scrollToPaymentIFrame(){$([document.documentElement,document.body]).animate({scrollTop:$("#paymentIFrameContainer").offset().top},100)}function isValidPromoCode(value){const regex=/^[a-zA-Z0-9#%&\u00a3]{0,10}$/;return regex.test(value)}
function setPromoCodeDetails(){if(promoCodeSaved&&isPromoCodeValid){$("#promocodeMsgDiv").show();$("#promocodeInput").val(promoCodeSaved);$("#promocodeInput").prop("readonly",true);$("#promocodeBtn").text("Remove");if(promoMsgContent)$("#promocodeMsgContent").html(promoMsgContent)}else{$("#promocodeBtn").attr("disabled",false);$("#promocodeMsgDiv").hide();$("#promocodeInput").val("")}}
function displayPromoLoading(status){$("#promocodeError").hide();if(status)$("#inlinePreLoader").show();else $("#inlinePreLoader").hide()}function displayPromoError(status,errorMsg){$("#loaderModal").modal("hide");if(status){$("#promocodeError").show();$("#promocodeErrorMsg").html(errorMsg)}else{$("#promocodeError").hide();$("#promocodeErrorMsg").html("")}}
function isExistAnyPriceTooHighPets(){var arr=[];var annualCostObj=feeDetailsResponse.result[0].productElementList.filter((v)=>v.category=="BASE_PREMIUM"&&v.cmCategory=="SELL")[0].price.perAnnum;pets.forEach((pet)=>{if(pet.attributes.covers){var vetFeeVal=pet.attributes.covers.filter((v)=>v.name=="VET_FEE")[0].value;if(parseFloat(vetFeeVal)<annualCostObj[pet.propertyReference])arr.push("true")}});if(arr.length>0)return true;else return false}
function adjustDDIframeHeight(isFormExpanded){if(isFormExpanded)if($(window).width()<600)$("#paymentFrame").height(2350);else if($(window).width()<768)$("#paymentFrame").height(2250);else $("#paymentFrame").height(1900);else if($(window).width()<600)$("#paymentFrame").height(900);else if($(window).width()<768)$("#paymentFrame").height(800);else $("#paymentFrame").height(700)};