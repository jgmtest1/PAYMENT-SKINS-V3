let faqOpened=null;
const DIMENSION={BREED:"dimension2",AMOUNT:"dimension3",WEIGHT:"dimension4",FAREWELL_COVER:"dimension6",EXCESS:"dimension7",MISSING_PET_COVER:"dimension10",BILL_SHARE:"dimension11",SELECTED_EXTRAS:"dimension13",VET_FEE:"dimension14",BEHAVIOURAL_COVER:"dimension15",THIRD_PARTY_LIABILITY:"dimension16",DENTAL_ILLNESS_COVER:"dimension17",IS_MICROCHIPPED:"dimension26",VERISK_SCORE:"dimension27",AWAITING_DIAGNOSIS:"dimension28",IS_NEUTERED:"dimension29",IS_SPAYED:"dimension30",GENDER:"dimension31",AGE:"dimension32",
HAS_MEDICAL:"dimension33"};
$(document).ready(function(){if(typeof measurementId!="undefined"){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"quoteId":quoteId!=null?quoteId:""});let evt={"event":"dataLoaded","site_version":PetVersion,"user":{"status":personReference?"recognised":"unrecognised","type":myAccountId!=null?"customer":"prospect","id":myAccountId!=null?myAccountId:""},"page":{"type":"quote.journey","decline":""},"blog":"","pet":getGTMPets(pets)};window.dataLayer.push(evt);if(isDev)console.log(evt);(function(w,
d,s,l,i){w[l]=w[l]||[];w[l].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!="dataLayer"?"\x26l\x3d"+l:"";j.async=true;j.src="https://www.googletagmanager.com/gtm.js?id\x3d"+i+dl;f.parentNode.insertBefore(j,f)})(window,document,"script","dataLayer",measurementId)}$(".ext-link").on("click",function(e){if(e.target.href.indexOf("petsure.com")==-1&&e.target.href.split("/").pop().indexOf(".")==-1){window.dataLayer=window.dataLayer||[];
window.dataLayer.push({"event":"ga_event","ga_event":{"category":"external link","action":"non-social","label":e.target.href,"value":0,"nonInteraction":0}})}else if(e.target.href.split("/").pop().indexOf(".")>-1||$(this).attr("gtm")=="download"){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"download","action":e.target.href.split("/").pop().indexOf(".")>-1?e.target.href.split("/").pop().split(".")[1]:"","label":e.target.href,"value":0,"nonInteraction":0}})}});
$("#helpOpen").on("click",function(){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":"help","label":"top banner","value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta","help","top banner"])});$("input[type\x3d'checkbox']").on("click",function(){if($(this).attr("gtm")){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":$(this).attr("gtm").split(":")[1],
"label":$(this).attr("gtm").split(":")[0],"value":$(this).is(":checked")?1:0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta",$(this).attr("gtm").split(":")[1],$(this).attr("gtm").split(":")[0],$(this).is(":checked")?1:0])}});$("input[type\x3d'radio']").on("click",function(){if($(this).attr("gtm")){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":$(this).attr("gtm").split(":")[1],"label":$(this).attr("gtm").split(":")[0],
"value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta",$(this).attr("gtm").split(":")[1],$(this).attr("gtm").split(":")[0]])}});var _paq=window._paq=window._paq||[];if(personReference!=null){_paq.push(["setCustomVariable",1,"personReference",personReference,"visit"]);_paq.push(["setCustomVariable",2,"quoteReference",quoteReference,"visit"]);if(phone!=null){_paq.push(["setCustomVariable",3,"email",email,"visit"]);_paq.push(["setCustomVariable",4,"phone",
phone,"visit"])}_paq.push(["setCustomDimension",1,pets.length])}$("a, button").on("click",function(){if($(this).attr("gtm")){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":$(this).attr("gtm").split(":")[1],"label":$(this).attr("gtm").split(":")[0],"value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta",$(this).attr("gtm").split(":")[1],$(this).attr("gtm").split(":")[0],0])}})});
function gtmSubmit(){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":"continue","label":"continue banner","value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta","continue","continue banner"])}
function gtmAccordion(action,label){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"accordion interaction","action":action,"label":label,"value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","accordion interaction",action,label])}
function gtmPurchase(response){if(typeof response==="string")response=JSON.parse(response);window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"eec.purchase","ecommerce":getEcommerce(response.purchasedQuote,response.purchasedPolicy,response.pets,response.newCost,response.monthlyCosts,response.annualCosts,response.payMethod)});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","eec.purchase","purchase complete"])}
function gtmSearch(action,label){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"content search","action":action,"label":label,"value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","content search",action,label])}
function gtmSlide(action,label){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"slider interaction","action":action,"label":label,"value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","slider interaction",action,label])}
function gtmFAQSHow(){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":"FAQs","label":"help","value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta","FAQs","help"])}
function gtmVoucherAction(action,value){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":action,"label":"a bit about you","value":value,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta",action,value])}
function gtmCallUsShow(){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_event","ga_event":{"category":"cta","action":"Call us","label":"help","value":0,"nonInteraction":0}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","cta","call us","help"])}function faqCollapse(title,idx){if(faqOpened==idx)faqOpened=null;else{faqOpened=idx;gtmAccordion(title,"faq")}}
function getGTMPet(pet){return{"hasPet":"Yes","microchipped":pet.attributes.isMicroChipped=="Y"?"Yes":pet.attributes.isMicroChipped=="N"?"No":"","verisk":pet.attributes.score!=null?pet.attributes.score.petRisk:0,"type":pet.attributes.species||"","breeed":pet.attributes.breed instanceof Array?pet.attributes.breed.join("|"):pet.attributes.breed||"","value":pet.attributes.amount||"","gender":pet.attributes.gender||"","spayed":pet.attributes.isSpayedOrNeutered!=""?pet.attributes.gender=="FEMALE"&&pet.attributes.isSpayedOrNeutered==
"Y"?"Yes":"No":"","neutered":pet.attributes.isSpayedOrNeutered!=""?pet.attributes.gender=="MALE"&&pet.attributes.isSpayedOrNeutered=="Y"?"Yes":"No":"","age":pet.attributes.age||"","awaitingDiagnosis":pet.attributes.hasAwaitingDiagnosis?pet.attributes.hasAwaitingDiagnosis=="Y"?"Yes":"No":"","vet":pet.attributes.hasMedicalCondition?pet.attributes.hasMedicalCondition=="Y"?"Yes":"No":""}}
function getGTMPets(pets){if(pets.length==0)return{"hasPet":"No","microchipped":"","verisk":"","type":"","breeed":"","value":"","gender":"","spayed":"","neutered":"","age":"","awaitingDiagnosis":"","vet":""};let mergedPet=null;for(let pet of pets)if(mergedPet)mergedPet=mergeJSON(mergedPet,getGTMPet(pet));else mergedPet=getGTMPet(pet);mergedPet.hasPet="Yes";return mergedPet}function mergeJSON(json1,json2){for(let key of Object.keys(json1))json1[key]=json1[key]+","+json2[key];return json1}
function getEcommerce(purchasedQuote,purchasedPolicy,pets,newCost,monthlyCosts,annualCosts,payMethod){let coupon=getCoupons(purchasedQuote.adjustments);let paymentMethod;if(payMethod=="1")paymentMethod="CARD";else if(payMethod=="2")paymentMethod="DIRECT_DEBIT";let eCommerce={"payment_method":paymentMethod,"currencyCode":"GBP","startDate":purchasedQuote.startDate,"coupon":""+coupon,"policyNumber":purchasedPolicy.policyNumber,"noOfPetsInsured":purchasedQuote.info.noOfPetsInsured,"isOptOutAutoRenewal":purchasedQuote.info.isOptOutAutoRenewal==
"Y"?"Yes":"No","purchase":{"actionField":{"id":purchasedPolicy.policyNumber,"affiliation":"","revenue":""+newCost.SELL,"tax":""+newCost.TAX,"shipping":"","coupon":""+coupon,"metric1":""+newCost.MARGIN},"products":[],"fulfillment":{"method":purchasedQuote.info.paymentType=="MONTHLY"?"monthly":"annually"},"order":{"saving":{"order":"","total":""}}}};let petNumber=0;pets.forEach((pet)=>{let attr=pet.attributes;let FAREWELL_COVER_=attr.extras.filter((extra)=>extra.name=="FAREWELL_COVER");let FAREWELL_COVER=
FAREWELL_COVER_.length>0?FAREWELL_COVER_[0].value=="Y"?"Yes":"No":"No";let MISSING_PET_COVER_=attr.extras.filter((extra)=>extra.name=="MISSING_PET_COVER");let MISSING_PET_COVER=MISSING_PET_COVER_.length>0?MISSING_PET_COVER_[0].value=="Y"?"Yes":"No":"No";let DENTAL_ILLNESS_COVER_=attr.extras.filter((extra)=>extra.name=="DENTAL_ILLNESS_COVER");let DENTAL_ILLNESS_COVER=DENTAL_ILLNESS_COVER_.length>0?DENTAL_ILLNESS_COVER_[0].value=="Y"?"Yes":"No":"No";let EXCESS_=attr.covers.filter((cover)=>cover.name==
"EXCESS");let EXCESS=EXCESS_.length>0?EXCESS_[0].value:"0";let BILL_SHARE_=attr.covers.filter((cover)=>cover.name=="BILL_SHARE");let BILL_SHARE=BILL_SHARE_.length>0?BILL_SHARE_[0].value:"0";let VET_FEE_=attr.covers.filter((cover)=>cover.name=="VET_FEE");let VET_FEE=VET_FEE_.length>0?VET_FEE_[0].value:"0";let BEHAVIOURAL_COVER_=attr.covers.filter((cover)=>cover.name=="BEHAVIOURAL_COVER");let BEHAVIOURAL_COVER=BEHAVIOURAL_COVER_.length>0?BEHAVIOURAL_COVER_[0].value:"0";let THIRD_PARTY_LIABILITY_=attr.covers.filter((cover)=>
cover.name=="THIRD_PARTY_LIABILITY");let THIRD_PARTY_LIABILITY=THIRD_PARTY_LIABILITY_.length>0?THIRD_PARTY_LIABILITY_[0].value:"0";let product={"id":pet.propertyReference,"name":"pet"+ ++petNumber,"price":""+annualCosts[pet.propertyReference].total,"variant":attr.species,"quantity":1,[DIMENSION.IS_MICROCHIPPED]:pet.attributes.isMicroChipped=="Y"?"Yes":pet.attributes.isMicroChipped=="N"?"No":"",[DIMENSION.VERISK_SCORE]:pet.attributes.score!=null?pet.attributes.score.petRisk:0,[DIMENSION.GENDER]:pet.attributes.gender||
"",[DIMENSION.IS_SPAYED]:pet.attributes.isSpayedOrNeutered!=""?pet.attributes.gender=="FEMALE"&&pet.attributes.isSpayedOrNeutered=="Y"?"Yes":"No":"",[DIMENSION.IS_NEUTERED]:pet.attributes.isSpayedOrNeutered!=""?pet.attributes.gender=="MALE"&&pet.attributes.isSpayedOrNeutered=="Y"?"Yes":"No":"",[DIMENSION.AGE]:pet.attributes.age||"",[DIMENSION.AWAITING_DIAGNOSIS]:pet.attributes.hasAwaitingDiagnosis?pet.attributes.hasAwaitingDiagnosis=="Y"?"Yes":"No":"",[DIMENSION.HAS_MEDICAL]:pet.attributes.hasMedicalCondition?
pet.attributes.hasMedicalCondition=="Y"?"Yes":"No":"",[DIMENSION.BREED]:attr.breed.join("|"),[DIMENSION.AMOUNT]:attr.amount,[DIMENSION.WEIGHT]:attr.breed[0].indexOf("Mixed Breed")>-1?attr.breed[0]:"",[DIMENSION.FAREWELL_COVER]:FAREWELL_COVER,[DIMENSION.EXCESS]:EXCESS,[DIMENSION.MISSING_PET_COVER]:MISSING_PET_COVER,[DIMENSION.BILL_SHARE]:BILL_SHARE,[DIMENSION.SELECTED_EXTRAS]:attr.extras.filter((extra)=>extra.value=="Y").map((extra)=>extra.name),[DIMENSION.VET_FEE]:VET_FEE,[DIMENSION.BEHAVIOURAL_COVER]:BEHAVIOURAL_COVER,
[DIMENSION.THIRD_PARTY_LIABILITY]:THIRD_PARTY_LIABILITY,[DIMENSION.DENTAL_ILLNESS_COVER]:DENTAL_ILLNESS_COVER,"brand":"Petsure","category":purchasedQuote.info.categoryDisplayName};eCommerce.purchase.products.push(product);var _paq=window._paq=window._paq||[];_paq.push(["addEcommerceItem",pet.propertyReference,"Petsure",purchasedQuote.info.categoryDisplayName,monthlyCosts[pet.propertyReference].total*1,1]);_paq.push(["setCustomDimension",2,purchasedQuote.info.paymentType=="MONTHLY"?"monthly":"annually"]);
_paq.push(["setCustomDimension",3,purchasedQuote.startDate])});var _paq=window._paq=window._paq||[];_paq.push(["trackEcommerceOrder",purchasedPolicy.policyNumber,newCost.SELL*1,0,newCost.TAX*1,0,false]);return eCommerce}function gtmPopup(name){window.dataLayer=window.dataLayer||[];window.dataLayer.push({"event":"ga_virtual","ga_virtual":{"popup":name}});var _paq=window._paq=window._paq||[];_paq.push(["trackEvent","virtual page","modal",name])}
function getCoupons(adjustmentArr){let adjustments=[];if(adjustmentArr&&adjustmentArr.length>0)adjustmentArr.forEach((adj)=>{if(adj.isValid)adjustments.push(adj.actualValue)});return adjustments.join(",")||""}
function gtmConversionsData(response){if(typeof response==="string")response=JSON.parse(response);window.dataLayer=window.dataLayer||[];let evt={"event":"user_details","user_provided_details":{"email_address":response.customerDetails.commMethods.filter((m)=>m.type=="EMAIL"&&m.order==1)[0].value,"phone_number":response.customerDetails.commMethods.filter((m)=>m.type=="PHONE"&&m.order==1).length>0?response.customerDetails.commMethods.filter((m)=>m.type=="PHONE"&&m.order==1)[0].value:"","address":{"first_name":response.customerDetails.firstName.toLowerCase(),
"last_name":response.customerDetails.lastName.toLowerCase(),"street":response.customerDetails.address.address1,"city":response.customerDetails.address.city,"postal_code":response.customerDetails.address.postcode,"country":response.customerDetails.address.countryCode}}};window.dataLayer.push(evt);if(isDev)console.log(evt)};