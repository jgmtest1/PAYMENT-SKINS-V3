var cardOptionsTree;var cardTypes;var patterns=[];var dataLoaded=false,treeLoaded=false;function initExternalRequest(){var a=new XMLHttpRequest();a.open("GET",getCompleteURL("../cardOptions?data=tree"),true);a.responseType="arraybuffer";a.onload=function(b){console.log("binary data response with status : "+this.status);if(this.readyState==4&&this.status==200&&a.response!=null){initialiseContentsOfBinaryTree(a.response);}};return a;}function getCompleteURL(a){var b=$("#txnref").val();if(b){return a+"&txnref="+b;}return a;}function initTypesRequest(){var a=new XMLHttpRequest();a.open("GET",getCompleteURL("../cardOptions?data=types"),true);a.responseType="text";a.onload=function(b){if(this.readyState==4&&this.status==200&&a.response!=null){var c=a.response.split(";");cardTypes=c[0].split(",");if(c.length>1){processPatterns(c[1]);}dataLoaded=true;if(treeLoaded){$("#cardNumber").off("blur",updateCardType);}}};return a;}function processPatterns(a){var c=a.split(",");for(var b in c){patterns.push({t:c[b].split(":")[0],p:"^"+c[b].split(":")[1].replace(/\?/g,"[0-9]")+"$",r:c[b].split(":")[1]});}}function initialiseContentsOfBinaryTree(c){console.log("Initialising array");try{var a=new Int8Array(c);console.log("finished initialising array : "+a.length);console.time("rebuild");cardOptionsTree=buildTree(a);console.timeEnd("rebuild");console.log("finished rebuilding tree");treeLoaded=true;if(dataLoaded){$("#cardNumber").off("blur",updateCardType);}}catch(b){console.log(b.message);}}function buildTree(a){var c=-1;var b=0;var e=[];for(var d=1;d<a.byteLength;d++){var f=a[d];switch(f){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:if(b===0){c=d;}b++;break;case 126:b--;if(b===0){e.push(buildTree(a.subarray(c,d+1)));}}}if(a[1]>9&&a[1]!=126){return{d:a[0],t:a[1],c:e};}else{return{d:a[0],c:e};}}function readCardData(){console.log("reading card data file");var a=initExternalRequest();a.send(null);a=initTypesRequest();a.send(null);}function findRangeFromTree(){var e=this.value.replace(/\s+/g,"");var b=[cardOptionsTree];var d=null;if(b[b.length-1]===undefined){return;}while(b[b.length-1].c.length!==0&&b.length-1<e.length){var h=b.length-1;var c=b[h];var a=null;var g=e.substring(h,h+1);for(var f in c.c){if(c.c[f].d<=g){a=c.c[f];}}if(a!=null&&a.d==g){c=a;b.push(c);}else{if(a!=null){c=a;b.push(c);b=rightMostDescendent(b);}else{while(b.length>1&&b[b.length-2].c[0]==c){b.pop();c=b[b.length-1];}if(b.length>1){b.pop();a=null;for(var f in b[b.length-1].c){if(b[b.length-1].c[f]!=c){a=b[b.length-1].c[f];}else{break;}}if(a!=null){b.push(a);b=rightMostDescendent(b);}else{setType(null,e,false);return;}}else{setType(null,e,false);return;}}}}setType(b[b.length-1].t,e,b[b.length-1].c.length>0);}function setType(b,d,a){var f=30;for(var c in patterns){if(d.match(patterns[c].p)!=null){b=patterns[c].t;}}var e;if(b!=null){e=cardTypes[b-f].toLowerCase();}else{if(a||canMatchPattern(d)){e="";}else{e=DEFAULT_CARD_TYPE;}}if(e!==currentCardType){currentCardType=e;$("#cardNumber").trigger("cardType-updated",[currentCardType]);}}function canMatchPattern(d){var b=false;for(var a in patterns){var c=patterns[a].r;if(d.length<c.length){c=c.substring(0,d.length);c=c.replace(/\?/g,"[0-9]");b=d.match(c)!=null;if(b){break;}}}return b;}function rightMostDescendent(a){var b=a[a.length-1];while(b.c.length!==0){b=b.c[b.c.length-1];a.push(b);}return a;}var cardTypeRequest;function updateCardType(a){var b=this.value.replace(/\s+/g,"");if(cardOptionsJsonFormat!==""){if(b){if(cardTypeRequest!=null){cardTypeRequest.abort();}cardTypeRequest=$.ajax({url:"../cardOptions",type:"POST",data:{pan:b,txnref:$("#txnref").val()},dataType:"text"}).done(function(c){cardTypeRequest=null;if(currentCardType!==c){currentCardType=c;$("#cardNumber").trigger("cardType-updated",[c]);}}).fail(function(c,d){if(d!=="abort"){cardTypeRequest=null;if(currentCardType!==DEFAULT_CARD_TYPE){currentCardType=DEFAULT_CARD_TYPE;$("#cardNumber").trigger("cardType-update-failed",[DEFAULT_CARD_TYPE]);}}});}else{if(currentCardType!==""){if(cardTypeRequest!=null){cardTypeRequest.abort();}currentCardType="";$("#cardNumber").trigger("cardType-updated",[""]);}}}}$(function(){$(document).ready(function(){if(cardOptionsConfigured){readCardData();$("#cardNumber").on("input",findRangeFromTree);}$("#cardNumber").on("blur",updateCardType);});});