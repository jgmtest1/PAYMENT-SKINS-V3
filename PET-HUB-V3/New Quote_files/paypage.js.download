var DEFAULT_CARD_TYPE="default";var TAB_KEY_CODE="9";var currentCardType;var currentCardOption;var cardOptionsJSON;var infoTemplateMsg;var monthsArray=monthsCommaSeparatedList.split(",");var isConfirmTokenPanelUsed;var isTokenEditPanelUsed;var formSubmitted=false;function isIE(){var a=navigator.userAgent.toLowerCase();return(a.indexOf("msie")!=-1)?parseInt(a.split("msie")[1]):false;}function applyNumberType(a){$(a).prop("type","text");$(a).prop("pattern","[0-9]*");$(a).prop("inputMode","numeric");}function applyHtml5Enhancement(){if(!isIE()){applyNumberType("#cardNumber");issueEnabled&&applyNumberType("#issue");if(startDateSelectionMode==="inputbox"){if(startMonthFormat==="mm"){applyNumberType("#startMonthText");}applyNumberType("#startYearText");}if(expiryDateSelectionMode==="inputbox"){if(expiryMonthFormat==="mm"){applyNumberType("#expiryMonthText");}applyNumberType("#expiryYearText");}$("#cardNumber").prop("placeholder",cardNumberPlaceholder);if(cscEnabled){applyNumberType("#csc");document.getElementById("confirmCsc")&&applyNumberType("#confirmCsc");$("#csc").prop("placeholder",cscPlaceholder);}if(cardholderNameEnabled){$("#cardholderName").prop("placeholder",cardholderNamePlaceholder);}if(enableAutocomplete==="true"){$("#expiryMonthText").prop("placeholder",expiryMonthPlaceholder);$("#expiryYearText").prop("placeholder",expiryYearPlaceholder);}if(startMonthFormat==="mm"){$("#startMonthText").prop("placeholder",startAndExpiryMonthMMFormatPlaceholder);}if(startMonthFormat==="MMM"){$("#startMonthText").prop("placeholder",startAndExpiryMonthMMMFormatPlaceholder);}if(startYearFormat==="yy"){$("#startYearText").prop("placeholder",startAndExpiryYearYYFormatPlaceholder);}if(startYearFormat==="yyyy"){$("#startYearText").prop("placeholder",startAndExpiryYearYYYYFormatPlaceholder);}if(expiryMonthFormat==="mm"){$("#expiryMonthText").prop("placeholder",startAndExpiryMonthMMFormatPlaceholder);}if(expiryMonthFormat==="MMM"){$("#expiryMonthText").prop("placeholder",startAndExpiryMonthMMMFormatPlaceholder);}if(expiryYearFormat==="yy"){$("#expiryYearText").prop("placeholder",startAndExpiryYearYYFormatPlaceholder);}if(expiryYearFormat==="yyyy"){$("#expiryYearText").prop("placeholder",startAndExpiryYearYYYYFormatPlaceholder);}}}function hideTooltips(){$("div.tooltip").hide();}function applyToolTips(){$("input[type='text'].formInput, input[type='tel'].formInput, select.formInput, input[type='checkbox'].formInput, input[type='text'].formInputForError, input[type='tel'].formInputForError, select.formInputForError, input[type='checkbox'].formInputForError").each(function(){$(this).focus(function(){hideTooltips();$("#"+$(this).prop("id")+"ToolTip").show();});});$("input[type='checkbox'].formInput, input[type='checkbox'].formInputForError").each(function(){$(this).click(function(){hideTooltips();$("#"+$(this).prop("id")+"ToolTip").show();});});}function openWindow(d,b,c,a){window.open(b,"_blank","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width="+c+", height="+a);d.preventDefault();}function applyFooterLinks(){$("#vbvAcceptanceMarkLink").click(function(a){openWindow(a,$(this).prop("href"),600,550);});$("#mcAcceptanceMarkLink").click(function(a){openWindow(a,$(this).prop("href"),600,550);});$("#amexAcceptanceMarkLink").click(function(a){openWindow(a,$(this).prop("href"),600,550);});$("#upiAcceptanceMarkLink").click(function(a){openWindow(a,$(this).prop("href"),600,550);});$("#jcbAcceptanceMarkLink").click(function(a){openWindow(a,$(this).prop("href"),600,550);});$("#googlepayAcceptanceMarkLink").click(function(a){openWindow(a,$(this).prop("href"),600,550);});$("#paypalAcceptanceMarkLink").click(function(a){openWindow(a,$(this).prop("href"),400,550);});}function applyAnalytics(){if($("#analyticsPanel").length!=0){populateAnalyticsData("cardEntryPageLoaded");}}function applyEvents(){var a=false;$("#confirmCscInlineLink").click(function(b){if($("#confirmCscInlinePanel").is(":visible")){$("#confirmCscInlinePanel").hide();$("#confirmCscInlineLink").attr("aria-label",cscHelpValue+" "+whatIsCSCInlineAdditionalInformation);}else{$("#confirmCscInlinePanel").show();$("#confirmCscInlineText").focus();$("#confirmCscInlineLink").attr("aria-label",cscDescription);}b.preventDefault();});$("#cscInlineLink").click(function(b){if($("#cscInlinePanel").is(":visible")){$("#cscInlinePanel").hide();$("#cscInlineLink").attr("aria-label",cscHelpValue+" "+whatIsCSCInlineAdditionalInformation);}else{$("#cscInlinePanel").show();$("#cscInlineText").focus();$("#cscInlineLink").attr("aria-label",cscDescription);}b.preventDefault();});$("#cscDescLink, #confirmCscDescLink").click(function(b){$("#closeCSCIconImg").prop("src",closeIcon);$("#cscImage").prop("src",cscImage);b.preventDefault();a=$("#btnSubmit").prop("disabled");$("form :input").prop("disabled",true);$("#overlay").height($(document).height());$("#overlay").show();$("#cscDialog").show();applyClosePopupDialogFocus();$("#closeCSCIcon").focus();});$("#closeCSCIcon, #closeCSCDesc").click(function(){$("#cscDialog").hide();if($("#confirmCscDescLink")!==""&&$("#confirmCscDescLink").length===1){$("#confirmCscDescLink").focus();}if($("#cscDescLink")!==""&&$("#cscDescLink").length===1){$("#cscDescLink").focus();}$("#overlay").hide();$("form :input").prop("disabled",false);if(cardTokenUsed){$("#cardNumber").prop("disabled",true);}if(confirmCheck1Disabled){$("#confirmCheck1").prop("disabled",true);}if(confirmCheck2Disabled){$("#confirmCheck2").prop("disabled",true);}if(a){$("#btnSubmit").prop("disabled",true);}return false;});$("#btnSubmit, #completeReferral").click(function(b){$("form :input").prop("readonly",true);$(".cancelButton").prop("disabled",true);$("#overlay").height($(document).height());$("#overlay").show();$("#waitPanel").show();});$(":radio").click(function(){visaCheckoutEarlyFlow=false;if($("input[name='paymentMethod']:checked").val()=="CARD"){$("#paymentDetailsPanel").slideDown("slow");}else{$("#paymentDetailsPanel").slideUp("slow");}});$("input[type=radio]").click(function(){if($("input[name='paymentMethod']:checked").val()!="VISA_CHECKOUT"){if($("#VmeCheckout > iframe").length>0){$("#VmeCheckout").remove();}}});$("img.paymentMethod, a.visaCheckoutOptionHelp").click(function(){var b=$(this).closest("li").find("input[type='radio']");if(b.val()!="VISA_CHECKOUT"){if($("#VmeCheckout > iframe").length>0){$("#VmeCheckout").remove();}}if(!b.attr("disabled")&&!b.prop("checked")){b.prop("checked",true).click().click();paymentMethodChanged(b.val());}});}function applyPanels(){if(displayManualAuthPanel){$("#completeCancelPanel").fadeIn(300);}if(showPayerAuthPostPanel){$("#payerAuthPostPanel").fadeIn(300);}if(paymentMethodsAvailable){$("#paymentMethodPanel").fadeIn(300);}if(paymentMethodsAvailable&&$("input[name='paymentMethod']:checked").val()!="CARD"&&$("#paymentMethodPanel").length!=0){$("#paymentDetailsPanel").hide();}}function applyInitialization(){$("#btnCancel").prop("formNoValidate",true);$("#jsEnabled").val("true");if(!isMobile&&$("input[name='paymentMethod']").length===0&&linkedErrors===""){if(focusField!==""&&!($("#"+focusField).attr("class")==="hidden")&&$("#"+focusField).length===1){$("#"+focusField).focus();}}if(enhancedErrorView==="true"&&linkedErrors!==""){$("a[id*='_error']")[0].focus();}isConfirmTokenPanelUsed=$("#confirmPaymentDetailsPanel").length>0;isTokenEditPanelUsed=$("#cardNumber").is(":disabled");if(cardTokenUsed&&(isConfirmTokenPanelUsed||isTokenEditPanelUsed)){currentCardType=tokenCardType;}else{if(($("#cardType").length>0&&$("#cardType").prop("value")!=="")){currentCardType=$("#cardType").prop("value");}else{if($("#cardNumber").prop("value")!==""){currentCardType=DEFAULT_CARD_TYPE;}else{currentCardType="";}}}if($("#cardType").length>0||tokenCardType.length>0){infoTemplateMsg=$("#infoMessage").text().replace("{0}","<span>{0}</span>");infoTemplateMsg=$("#infoMessage").text().replace("{1}","<span>{1}</span>");$("#infoMessagePanel").hide();$("#purchaseDetailsSurchargeAmount").hide();$("#purchaseDetailsTotalAmount").hide();
$("#basketSurchargeAmountPanel").hide();$("#basketTotalAmountPanel").hide();if($("#purchaseDetailsFooterPanel").length>0&&$("#purchaseDetailsFooterSurchargeAmount").length>0){$("#purchaseDetailsFooterSurchargeAmountPanel").hide();$("#purchaseDetailsFooterTotalAmountPanel").hide();}}if(isTokenEditPanelUsed&&tokenCardType.length>0){$("#cardTypeSection").hide();}}function applyTokenModeFocus(){if(isTokenEditPanelUsed){if($(".formInput").length>1){$(".formInput")[1].focus();}}}function logToConsole(a){if(window.console&&window.console.log){console.log(a);}}function disableSpellCheck(){document.getElementById("cardholderName")&&document.getElementById("cardholderName").setAttribute("spellcheck",false);document.getElementById("confirmCardholderName")&&document.getElementById("confirmCardholderName").setAttribute("spellcheck",false);}$(function(){applyInitialization();applyBrowserInfo();applyHtml5Enhancement();applyToolTips();applyEvents();applyPanels();applyFooterLinks();applyAnalytics();applyTokenModeFocus();hideSurcharge();aboutPopupBinding();setUpPaymentMethodCallbacks();callDirectPaymentMethodCallback(paymentMethod);applyPayNowButtonText();applySubmitBinding();applyVisaCheckoutPaymentMethodBinding();applyVisaCheckoutChangeCardBinding();initVisaCheckoutFlow();applyErrorMessageDesc();applyCSCLinkAdditionalInfo();removeInlineErrors();disableSpellCheck();if($("#errorMessageDiv").children().length!==0){if(enhancedErrorView==="false"){setFocusOnFirstVisibleField();}}applyAriaRequiredFlag();initializeAriaInvalidFlag();});function removeInlineErrors(){if($("#semafone").length==0){$("div.formSection[class*='required'] input[type='text'].formInputForError, div.formSection[class*='required'] input[type='tel'].formInputForError").each(function(){$(this).on("change keyup",removeInputFieldsInlineError);});$("div.formSection[class*='required'] select.formInputForError").each(function(){$(this).on("change",removeInputFieldsInlineError);});$("div.formSection[class*='required'] input[type='checkbox'].formInputForError").each(function(){$(this).on("blur click",removeCheckboxValidationError);});if(linkedErrors!==""){var a=initializeLinkedErrorArray();for(var b=0;b<a.length;b++){var d=a[b].trim();var c="#"+d;if(!$(c).parents("div.formSection").hasClass("required")){$(c).on("change keyup",removeInputFieldsInlineError);}}}}}function removeCheckboxValidationError(a){switch($(this).prop("id")){case"confirmCheck1":if($("#confirmCheck1").hasClass("formInputForError")){$("#confirmCheck1MessagePanel").css("display","none");$("#confirmCheck1").removeClass("formInputForError").addClass("formInput");$("#confirmCheck1_list").remove();}break;case"confirmCheck2":if($("#confirmCheck2").hasClass("formInputForError")){$("#confirmCheck2MessagePanel").css("display","none");$("#confirmCheck2").removeClass("formInputForError").addClass("formInput");$("#confirmCheck2_list").remove();}break;}if($("#errorMessageDiv").children().length===1){$("#messagePanel").remove();}}function removeInputFieldsInlineError(b){var a=b.keyCode?b.keyCode:b.charCode;if(a!==TAB_KEY_CODE){setAriaInvalidAttribute(this,false);switch($(this).prop("id")){case"cardType":if($("#cardType").hasClass("formInputForError")){if($("#cardType_list").length){$("#cardType_list").remove();}if($("#cardTypeMessagePanel").length){$("#cardTypeMessagePanel").css("display","none");}$("#cardType").removeClass("formInputForError").addClass("formInput");}break;case"expiryMonth":if($("#expiryMonth").hasClass("formInputForError")){$("#expiryDateMessagePanel").css("display","none");$("#expiryMonth").removeClass("formInputForError").addClass("formInput");$("#expiryMonth_list").remove();}break;case"expiryYear":if($("#expiryYear").hasClass("formInputForError")){$("#expiryDateMessagePanel").css("display","none");$("#expiryYear").removeClass("formInputForError").addClass("formInput");$("#expiryMonth_list").remove();}break;case"expiryMonthText":if($("#expiryMonthText").hasClass("formInputForError")){$("#expiryDateMessagePanel").css("display","none");$("#expiryMonthText").removeClass("formInputForError").addClass("formInput");$("#expiryMonthText_list").remove();}break;case"expiryYearText":if($("#expiryYearText").hasClass("formInputForError")){$("#expiryDateMessagePanel").css("display","none");$("#expiryYearText").removeClass("formInputForError").addClass("formInput");$("#expiryMonthText_list").remove();}break;case"startMonth":if($("#startMonth").hasClass("formInputForError")){$("#startDateMessagePanel").css("display","none");$("#startMonth").removeClass("formInputForError").addClass("formInput");$("#startMonth_list").remove();}break;case"startYear":if($("#startYear").hasClass("formInputForError")){$("#startDateMessagePanel").css("display","none");$("#startYear").removeClass("formInputForError").addClass("formInput");$("#startMonth_list").remove();}break;case"startMonthText":if($("#startMonthText").hasClass("formInputForError")){$("#startDateMessagePanel").css("display","none");$("#startMonthText").removeClass("formInputForError").addClass("formInput");$("#startMonthText_list").remove();}break;case"startYearText":if($("#startYearText").hasClass("formInputForError")){$("#startDateMessagePanel").css("display","none");$("#startYearText").removeClass("formInputForError").addClass("formInput");$("#startMonthText_list").remove();}break;case"cardholderName":if($("#cardholderName").hasClass("formInputForError")){$("#cardholderNameMessagePanel").css("display","none");$("#infoMessage span").addClass("highlight");$("#cardholderName").removeClass("formInputForError").addClass("formInput");$("#cardholderName_list").remove();}break;case"confirmCardholderName":break;case"cardNumber":if($("#cardNumber").hasClass("formInputForError")){$("#cardholderNumberMessagePanel").css("display","none");$("#cardNumber").removeClass("formInputForError").addClass("formInput");$("#cardNumber_list").remove();if($("#cardType_list").length&&isCardTypeDetectionConfigured){$("#cardType_list").remove();}if($("#cardTypeMessagePanel").length&&isCardTypeDetectionConfigured){$("#cardTypeMessagePanel").css("display","none");}}break;case"issue":if($("#issue").hasClass("formInputForError")){$("#issueMessagePanel").css("display","none");$("#issue").removeClass("formInputForError").addClass("formInput");$("#issue_list").remove();}break;case"csc":if($("#csc").hasClass("formInputForError")){$("#cscMessagePanel").css("display","none");$("#csc").removeClass("formInputForError").addClass("formInput");$("#csc_list").remove();}else{if($("#csc").siblings("div.errorMessagePanel").children("div[role='alert']").children("div.errorText").length==1){$("#cscMessagePanel").css("display","none");$("#csc_list").remove();}}break;case"confirmCsc":break;}}if($("#errorMessageDiv").children().length===1){$("#messagePanel").remove();}}function applyCSCLinkAdditionalInfo(){if(cscLinkSelectionMode==="popup"){if($("#cscDescLink")!==""&&$("#cscDescLink").length===1){document.getElementById("cscDescLink").setAttribute("aria-label",cscHelpValue+" "+whatIsCSCPopupAdditionalInformation+" ");}if($("#confirmCscDescLink")!==""&&$("#confirmCscDescLink").length===1){document.getElementById("confirmCscDescLink").setAttribute("aria-label",cscHelpValue+" "+whatIsCSCPopupAdditionalInformation+" ");}}if(cscLinkSelectionMode==="inline"){if($("#cscInlineLink")!==""&&$("#cscInlineLink").length===1){document.getElementById("cscInlineLink").setAttribute("aria-label",cscHelpValue+" "+whatIsCSCInlineAdditionalInformation+" ");}if($("#confirmCscInlineLink")!==""&&$("#confirmCscInlineLink").length===1){document.getElementById("confirmCscInlineLink").setAttribute("aria-label",cscHelpValue+" "+whatIsCSCInlineAdditionalInformation+" ");}}}function onSubmitButton(){if(formSubmitted){event.preventDefault();}else{formSubmitted=true;}paymentMethod=$("input[name=paymentMethod]:checked").val();var a=selectPaymentMethodCallbacks[paymentMethod];if(a!=null){$(".submitButton, .cancelButton").prop("disabled",true);return a.call();}return true;}function hideSurcharge(){$("#paymentMethod").click(function(){if(!$("input[name='paymentMethod']").first().prop("checked")){$("#purchaseDetailsSurchargeAmount").hide();
$("#basketTotalAmountPanel").hide();$("#basketSurchargeAmountPanel").hide();$("#infoMessagePanel").hide();$("select[name='cartype']").selectedIndex=0;$("#paymentMethod").selectedIndex=0;$("#cardType").parents("div.formSection").removeClass("inputValid");$("#cardType").each(function(){this.selectedIndex=0;});}});}function aboutPopupBinding(){$("#aboutMasterpass").on("click",function(b){b.preventDefault();var a=$("#about_iframe")[0];a.src=b.currentTarget.href;$("#about").dialog("open");return false;});$("#about").dialog({autoOpen:false,title:" ",draggable:false,width:500,height:800,resizable:true,modal:true,});}function applyPayNowButtonText(){$("#btnSubmit").val(format(submitOrderButtonText,transactionAmount));}function format(b){for(var a=0;a<arguments.length-1;a++){b=b.replace("{"+a+"}",arguments[a+1]);}return b;}function applySubmitBinding(){$("#btnSubmit").on("click",function(a){return onSubmitButton();});}function setUpPaymentMethodCallbacks(){selectPaymentMethodCallbacks={MASTER_PASS:function(){return masterpass_v6_checkout(ctxPath+"/rest/payment/"+$("#txnref").val()+"/pay/MasterPass",function(){window.location.reload();});},PBBA:function(){requestRTP("POST",ctxPath+"/rest/payment/"+$("#txnref").val()+"/pay/PBBA",$("#cardEntryForm"));return false;}};directPaymentMethodCallbacks={PBBA:function(){requestRTP("GET",ctxPath+"/rest/payment/"+$("#txnref").val(),$("#cardEntryForm"));return false;}};}function callDirectPaymentMethodCallback(a){var b=directPaymentMethodCallbacks[a];if(b!=null){$("#paymentDetailsPanel").hide();$(".submitButton, .cancelButton").prop("disabled",true);disableSubmitButton=false;return b.call();}}function addClientError(c,b){if(c===INVALID_CARD_TYPE_TOP_MSG_ID||c===ERROR_DETECTING_CARD_TYPE_MSG_ID){var a=document.getElementById("cardType").className.includes("hidden")?"#cardNumber":"#cardType";if($("#messagePanel a[data-id="+c+"]").length==0){$('#messagePanel div[role="alert"]').append('<li><a href="'+a+'" data-id="'+c+'" class="errorText" style="color: #085DA9">'+b+"</a></li>");$("#messagePanel").show();}}else{if($("#messagePanel div[data-id="+c+"]").length==0){$('#messagePanel div[role="alert"]').append('<div data-id="'+c+'" class="errorText">'+b+"</div>");$("#messagePanel").show();}}}function removeClientError(a){if(a===INVALID_CARD_TYPE_TOP_MSG_ID||a===ERROR_DETECTING_CARD_TYPE_MSG_ID){$("#messagePanel a[data-id="+a+"]").parent().remove();}else{$("#messagePanel div[data-id="+a+"]").remove();}if($("#messagePanel .errorText").length==0){$("#messagePanel").hide();}}function removeAllErrors(){$("#messagePanel div.errorText").remove();$("#messagePanel").hide();}function clearPaymentDetails(){$("#semafoneCardType").val("");$("#cardType").prop("selectedIndex",0);$("#cardholderName").val("");$("#cardNumber").val("");$("#cardTypeDetection").text("");$("#expiryMonth").prop("selectedIndex",0);$("#expiryYear").prop("selectedIndex",0);$("#startMonth").prop("selectedIndex",0);$("#startYear").prop("selectedIndex",0);$("#issue").val("");$("#csc").val("");$("#confirmCheck1").prop("checked",false);$("#confirmCheck2").prop("checked",false);}function isCardOptionsPresent(){return typeof setCurrentCardType==="function";}function applyVisaCheckoutPaymentMethodBinding(){$('input[name="paymentMethod"]:radio').change(function(a){paymentMethodChanged($(a.target).val());});}function paymentMethodChanged(a){clearPaymentDetails();if(a=="VISA_CHECKOUT"){setSubmitButtonVisaCheckout();}else{setSubmitButtonPayNow();hideVisaCheckoutPaymentDetails();updateBillingAddress(billingAddressFromMerchant);}$("#cardNumber").trigger("input");}function applyVisaCheckoutChangeCardBinding(){$(".visaCheckoutChangeCard").click(function(a){a.preventDefault();$("#btnVisaCheckout").click();});}function setSubmitButtonPayNow(){$(".submit-VisaCheckout").hide();$(".submit-PayNow").fadeIn(150);}function setSubmitButtonVisaCheckout(){$(".submit-PayNow").hide();$(".submit-VisaCheckout").fadeIn(300);}function isVisaCheckoutSelected(){return $("input[name=paymentMethod]:checked").val()=="VISA_CHECKOUT";}function disableVisaCheckout(){$("#paymentMethod_VISA_CHECKOUT").attr("disabled",true);$("img.paymentMethodVISA_CHECKOUT").hide();$("img.paymentMethodVISA_CHECKOUT_DISABLED").show();}var visaCheckoutErrorId="visaCheckoutErrorId";function showVisaCheckoutPaymentDetails(a,b){if($("#purchaseDetailsPanel").length>0){$("#visaCheckoutPaymentSummaryAmountValue").text($("#amount").text());}else{if($("#basketPanel").length>0){$("#visaCheckoutPaymentSummaryAmountValue").text($("#basketItemTotal").text());}}if(addressEnabledForStore&&billingAddressEnabledForStore&&(a||b.billingAddressChanged)){$("#visaCheckoutAddressChangeWarning").show();}else{$("#visaCheckoutAddressChangeWarning").hide();}if(b.paymentMethod=="TOKEN"){$("#visaCheckoutCardExpiry").hide();}else{$("#visaCheckoutCardExpiry").show();}$(".visaCheckoutPanel").fadeIn(300);if(isCardOptionsAndSurchargePresent()){$(".visaCheckoutSurchargeWarning").fadeIn(300);}else{$(".visaCheckoutSurchargeWarning").fadeOut(300);$(".visaCheckoutPanel .surcharge").hide();}}function hideVisaCheckoutPaymentDetails(){$(".visaCheckoutPanel").fadeOut(300);$(".visaCheckoutSurchargeWarning").fadeOut(300);}function isCardOptionsAndSurchargePresent(){return isCardOptionsPresent()&&isSurchargePresent();}function onVisaCheckoutReady(){V.init({apikey:visaCheckoutConfig.apiKey,externalClientId:visaCheckoutConfig.externalClientId,externalProfileId:visaCheckoutConfig.externalProfileId,settings:{shipping:{collectShipping:"false"},displayName:visaCheckoutConfig.displayName}});V.on("payment.success",function(a){logToConsole("VISA Checkout: card selected successfully using normal (late) payment flow");removeAllErrors();visaCheckoutEarlyFlow=false;getPaymentData(false,a);});V.on("payment.cancel",function(a){logToConsole("VISA Checkout: user cancelled card selection");removeClientError(visaCheckoutErrorId);});V.on("payment.error",function(a,b){if(b){logToConsole("VISA Checkout: error from visa checkout. code: "+b.code+", message: "+b.message);}addClientError(visaCheckoutErrorId,visaCheckoutUnavailableMsg);if(!isVisaCheckoutSelected()){disableVisaCheckout();}$(window).scrollTop(0);});}function showAjaxSpinner(){$("#overlay").height($(document).height());$("#overlay").show();$("#waitPanel").show();}function hideAjaxSpinner(){$("#waitPanel").hide();$("#overlay").hide();$("#overlay").height(0);}function getPaymentData(b,a){$.ajax({url:ctxPath+"/rest/visacheckout/payment-data/"+$("#txnref").val(),type:"POST",contentType:"application/json",data:JSON.stringify({type:"VISA_CHECKOUT",visaCheckoutDetails:{callId:b?undefined:a.callid,visaCheckoutRequestType:"GET_PAYMENT_DATA"}}),beforeSend:function(){showAjaxSpinner();},success:function(c){updateVisaCheckoutDetails(c);showVisaCheckoutPaymentDetails(b,c);setSubmitButtonPayNow();},error:function(c){addClientError(visaCheckoutErrorId,visaCheckoutUnavailableMsg);$(window).scrollTop(0);},complete:function(){hideAjaxSpinner();}});}function updateVisaCheckoutDetails(a){updateBillingAddress(a.billingAddress);updateCardArt(a);$("#visaCheckoutCardTypeValue").text(a.cardType);$("#visaCheckoutCardNumberValue").text(a.maskedPan);$("#visaCheckoutCardExpiryValue").text(a.expiryDate);}function updateCardArt(a){var b=a.cardImage?a.cardImage.imageUrl:"";if(b){$(".cardArt.image").attr("src",b).on("load",function(){if(this.complete&&typeof this.naturalWidth!="undefined"&&this.naturalWidth>0){$(".cardArt").fadeIn(300);}else{removeCardArt();}}).on("error",function(){removeCardArt();});}else{removeCardArt();}}function removeCardArt(){$(".cardArt.image").removeAttr("src");$(".cardArt").fadeOut(300);}function updateBillingAddress(a){if(addressEnabledForStore&&billingAddressEnabledForStore&&a){updateAddressField("billingAddressName",a.name);updateAddressField("billingAddressLine1",a.line1);updateAddressField("billingAddressLine2",a.line2);updateAddressField("billingAddressCity",a.city);updateAddressField("billingAddressCounty",a.county);updateAddressField("billingAddressCountry",a.countryLocalised);
updateAddressField("billingAddressPostCode",a.postcode);}}function updateAddressField(c,b){var a=$("#"+c);if(b){a.innerHTML=b;a.css("display","block");}else{a.hide();}}function initVisaCheckoutFlow(){if(visaCheckoutEarlyFlow&&!isMessageDisplayed()){logToConsole("VISA Checkout: card selected successfully using early payment flow");removeAllErrors();selectPaymentMethod("VISA_CHECKOUT");getPaymentData(true);}}function selectPaymentMethod(a){$("#paymentMethod_"+a).prop("checked",true);}function isMessageDisplayed(){return $("#messagePanel").is(":visible");}function applyErrorMessageDesc(){$("#cardholderName").attr("aria-describedby","cardholderNameErrorMessageDiv");$("#cardType").attr("aria-describedby","cardTypeErrorMessageDiv");$("#cardNumber").attr("aria-describedby","cardholderNumberErrorMessageDiv");$("#expiryMonthText").attr("aria-describedby","expiryDateErrorMessageDiv");$("#expiryYearText").attr("aria-describedby","expiryDateErrorMessageDiv");$("#expiryMonth").attr("aria-describedby","expiryDateErrorMessageDiv");$("#expiryYear").attr("aria-describedby","expiryDateErrorMessageDiv");$("#startMonth").attr("aria-describedby","startDateErrorMessageDiv");$("#startYear").attr("aria-describedby","startDateErrorMessageDiv");$("#startMonthText").attr("aria-describedby","startDateErrorMessageDiv");$("#startYearText").attr("aria-describedby","startDateErrorMessageDiv");$("#issue").attr("aria-describedby","issueErrorMessageDiv");$("#csc").attr("aria-describedby","cscErrorMessageDiv");$("#confirmCheck1").attr("aria-describedby","confirmCheck1ErrorMessageDiv");$("#confirmCheck2").attr("aria-describedby","confirmCheck2ErrorMessageDiv");}function applyAriaRequiredFlag(){initializeAriaRequiredFlag();$("div.formSection[class*='required'] input[type='text'].formInput, div.formSection[class*='required'] input[type='tel'].formInput").each(function(){$(this).attr("aria-required",true);});$("div.formSection[class*='required'] input[type='text'].formInputForError, div.formSection[class*='required'] input[type='tel'].formInputForError").each(function(){$(this).attr("aria-required",true);});$("div.formSection[class*='required'] select.formInput").each(function(){$(this).attr("aria-required",true);});$("div.formSection[class*='required'] select.formInputForError").each(function(){$(this).attr("aria-required",true);});$("div.formSection[class*='required'] input[type='checkbox'].formInput").each(function(){$(this).attr("aria-required",true);});$("div.formSection[class*='required'] input[type='checkbox'].formInputForError").each(function(){$(this).attr("aria-required",true);});}function initializeAriaRequiredFlag(){$(".formInput").filter(":input").each(function(){$(this).attr("aria-required",false);});}function initializeAriaInvalidFlag(){$(".formInputForError").filter(":input").each(function(){setAriaInvalidAttribute(this,true);});}function setAriaInvalidAttribute(b,a){var c=$(b).attr("id");$(b).attr("aria-invalid",a);$.each({expiryMonth:"expiryYear",expiryYear:"expiryMonth",startMonth:"startYear",startYear:"startMonth"},function(d,e){if(c.indexOf(d)>=0){$("#"+e).length>0?$("#"+e).attr("aria-invalid",a):"";$("#"+e+"Text").length>0?$("#"+e+"Text").attr("aria-invalid",a):"";}});}function setFocusOnFirstVisibleField(){$(".formInput")[0].focus();}function applyClosePopupDialogFocus(){const d="img, a[href]";const c=document.querySelector("#cscDialog");const b=c.querySelectorAll(d)[0];const a=c.querySelectorAll(d);const e=a[a.length-1];document.addEventListener("keydown",function(f){if(!(f.key==="Tab"||f.keyCode===9)){return;}if(f.shiftKey){if(document.activeElement===b){e.focus();f.preventDefault();}}else{if(document.activeElement===e){b.focus();f.preventDefault();}}});b.focus();}function isInlineValidationEnabled(){return $("#jsValidation").length!==0;}function initializeLinkedErrorArray(){return linkedErrors.trim().replace("[","").replace("]","").split(",");}
